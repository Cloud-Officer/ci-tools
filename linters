#!/usr/bin/env bash
shopt -s globstar

FAILED=0

yml_files=(.github/workflows/*.yml)
yaml_files=(.github/workflows/*.yaml)

if [[ -e ${yml_files[0]} ]] || [[ -e ${yaml_files[0]} ]]; then
  echo "Checking GitHub Actions workflow files..."

  if ! command -v actionlint &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install actionlint
    else
      go install github.com/rhysd/actionlint/cmd/actionlint@latest
      export PATH="${PATH}:${HOME}/go/bin"
    fi
  fi

  actionlint || FAILED=1
fi

if [ -f .markdownlint.yml ]; then
  echo "Checking Markdown..."

  if ! command -v markdownlint-cli2 &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install markdownlint-cli2
    elif command -v npm &>/dev/null; then
      if command -v npm | grep "${HOME}" &>/dev/null; then
        SUDO=""
      else
        SUDO="sudo"
      fi

      ${SUDO} npm install -g markdownlint-cli2
    fi
  fi

  markdownlint-cli2 "**/*.md" "#.*" "#**/vendor/**" "#**/node_modules/**" "#**/Libraries/**" "#**/Pods/**" || FAILED=1
fi

if [ -f .yamllint.yml ]; then
  echo "Checking YAML..."

  if ! command -v yamllint &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install yamllint
    else
      sudo apt-get --yes install --no-install-recommends yamllint
    fi
  fi

  yamllint --strict . || FAILED=1
fi

if [ -f .shellcheckrc ]; then
  echo "Checking shell scripts..."

  if ! command -v shellcheck &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install shellcheck
    else
      sudo apt-get --yes install --no-install-recommends shellcheck
    fi
  fi

  shellcheck --external-sources ./**/*.sh || FAILED=1
fi

if [ -f .hadolint.yaml ]; then
  echo "Checking Dockerfiles..."

  if ! command -v hadolint &>/dev/null; then
    brew install hadolint
  fi

  # shellcheck disable=SC2046
  hadolint $(find . -name Dockerfile -not -path "*/vendor/*" -not -path "*/node_modules/*" -not -path "*/Libraries/*" -not -path "*/Pods/*") || FAILED=1
fi

if [ -f .golangci.yml ]; then
  echo "Checking Go..."

  if ! command -v golangci-lint &>/dev/null; then
    brew install golangci-lint
  fi

  golangci-lint run || FAILED=1
fi

if [ -f .pmd.xml ]; then
  echo "Checking Java/JS/SQL with pmd..."

  if ! command -v pmd &>/dev/null; then
    brew install pmd
  fi

  pmd check --dir . --format textcolor --rulesets ".pmd.xml" || FAILED=1
  echo
fi

if [ -f .eslintrc.json ]; then
  echo "Checking JS with eslint..."

  INSTALL_ESLINT=0

  if ! command -v eslint &>/dev/null; then
    echo "Installing eslint@8 because not present"
    INSTALL_ESLINT=1
  fi

  if ! eslint --version | grep "^v8\." &>/dev/null; then
    echo "Installing eslint@8 because wrong version"
    INSTALL_ESLINT=1
  fi

  if [ ${INSTALL_ESLINT} -eq 1 ]; then
    if uname -s | grep Darwin &>/dev/null; then
      npm install -g eslint@8
    else
      if ! command -v npm &>/dev/null; then
        sudo apt-get --yes install --no-install-recommends npm
      fi

      if command -v npm | grep "${HOME}" &>/dev/null; then
        SUDO=""
      else
        SUDO="sudo"
      fi

      ${SUDO} npm install -g eslint@8
    fi
  fi

  eslint --ignore-pattern "vendor/" --ignore-pattern "node_modules/" --ignore-pattern "Libraries/" --ignore-pattern "Pods/" . || FAILED=1
fi

if [ -f .editorconfig ]; then
  echo "Checking Kotlin with ktlint..."

  if ! command -v ktlint &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install ktlint
    else
      sudo apt-get --yes install --no-install-recommends ktlint
    fi
  fi

  ktlint --verbose || FAILED=1
fi

if [ -f .bandit ]; then
  echo "Checking Python with bandit..."

  if ! command -v bandit &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install bandit
    else
      sudo apt-get --yes install --no-install-recommends python3-bandit
    fi
  fi

  bandit -ll --ini .bandit --silent . || FAILED=1
  echo
fi

if [ -f .flake8 ]; then
  echo "Checking Python with flake8..."

  if ! command -v flake8 &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install flake8
    else
      sudo apt-get --yes install --no-install-recommends flake8
    fi
  fi

  #if ! pip3 list | grep flake8-docstrings &>/dev/null; then
  #  pip3 install --upgrade flake8-docstrings
  #fi

  flake8 --exclude=vendor,node_modules,Libraries,Pods . || FAILED=1
fi

if [ -f .protolint.yaml ]; then
  echo "Checking Protocol Buffer with protolint..."

  if ! command -v protolint &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew tap yoheimuta/protolint
      brew install protolint
    else
      go install github.com/yoheimuta/protolint/cmd/protolint@latest
      export PATH="${PATH}:${HOME}/go/bin"
    fi
  fi

  protolint . || FAILED=1
fi

if [ -f .rubocop.yml ]; then
  echo "Checking Ruby..."

  if ! rubocop --version &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      gem install rubocop rubocop-capybara rubocop-graphql rubocop-i18n rubocop-minitest rubocop-performance rubocop-rails rubocop-rake rubocop-rspec rubocop-rspec_rails rubocop-thread_safety
    else
      if command -v gem | grep "${HOME}" &>/dev/null; then
        SUDO=""
      else
        SUDO="sudo"
      fi

      ${SUDO} gem install rubocop rubocop-capybara rubocop-graphql rubocop-i18n rubocop-minitest rubocop-performance rubocop-rails rubocop-rake rubocop-rspec rubocop-rspec_rails rubocop-thread_safety
    fi
  fi

  rubocop || FAILED=1
  echo
fi

if [ -f .semgrepignore ]; then
  echo "Checking with semgrep..."

  if ! command -v semgrep &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install semgrep
    else
      pip3 install semgrep
    fi
  fi

  semgrep scan --config=auto --severity=ERROR --error . || FAILED=1
fi

if [ -f .swiftlint.yml ]; then
  echo "Checking Swift..."

  if ! command -v swiftlint &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install swiftlint
    else
      echo "Error: only supported on MacOS!"
      exit 1
    fi
  fi

  swiftlint lint --strict || FAILED=1
fi

if [ ${FAILED} -eq 1 ]; then
  echo "Some checks failed."
  exit 1
fi

echo "All checks passed."
