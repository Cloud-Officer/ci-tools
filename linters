#!/usr/bin/env bash
set -euo pipefail
shopt -s globstar

FAILED=0

yml_files=(.github/workflows/*.yml)
yaml_files=(.github/workflows/*.yaml)

if [[ -e ${yml_files[0]} ]] || [[ -e ${yaml_files[0]} ]]; then
  echo "Checking GitHub Actions workflow files..."

  if ! command -v actionlint &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install actionlint
    else
      go install github.com/rhysd/actionlint/cmd/actionlint@latest
      export PATH="${PATH}:${HOME}/go/bin"
    fi
  fi

  actionlint || FAILED=1
fi

if [ -f .markdownlint.yml ]; then
  echo "Checking Markdown..."

  if ! command -v markdownlint-cli2 &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install markdownlint-cli2
    elif command -v npm &>/dev/null; then
      if command -v npm | grep "${HOME}" &>/dev/null; then
        SUDO=""
      else
        SUDO="sudo"
      fi

      ${SUDO} npm install -g markdownlint-cli2
    fi
  fi

  markdownlint-cli2 "**/*.md" "#.*" "#**/vendor/**" "#**/node_modules/**" "#**/Libraries/**" "#**/Pods/**" || FAILED=1
fi

if [ -f .yamllint.yml ]; then
  echo "Checking YAML..."

  if ! command -v yamllint &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install yamllint
    else
      sudo apt-get --yes install --no-install-recommends yamllint
    fi
  fi

  yamllint --strict . || FAILED=1
fi

if [ -f .shellcheckrc ]; then
  echo "Checking shell scripts..."

  if ! command -v shellcheck &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install shellcheck
    else
      sudo apt-get --yes install --no-install-recommends shellcheck
    fi
  fi

  shellcheck --external-sources ./**/*.sh || FAILED=1
fi

if [ -f .hadolint.yaml ]; then
  echo "Checking Dockerfiles..."

  if ! command -v hadolint &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install hadolint
    else
      wget -qO /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
      EXPECTED_CHECKSUM=$(wget -qO - https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64.sha256 | awk '{print $1}')

      if command -v sha256sum &> /dev/null; then
        ACTUAL_CHECKSUM=$(sha256sum /usr/local/bin/hadolint | awk '{print $1}')
      else
        ACTUAL_CHECKSUM=$(shasum -a 256 /usr/local/bin/hadolint | awk '{print $1}')
      fi

      if [ "${EXPECTED_CHECKSUM}" != "${ACTUAL_CHECKSUM}" ]; then
        echo "Error: Checksum verification failed for hadolint!"
        echo "Expected: ${EXPECTED_CHECKSUM}"
        echo "Actual:   ${ACTUAL_CHECKSUM}"
        rm -f /usr/local/bin/hadolint
        exit 1
      fi

      chmod +x /usr/local/bin/hadolint
    fi
  fi

  # shellcheck disable=SC2046
  hadolint $(find . -name Dockerfile -not -path "*/vendor/*" -not -path "*/node_modules/*" -not -path "*/Libraries/*" -not -path "*/Pods/*") || FAILED=1
fi

if [ -f .cfnlintrc ]; then
  echo "Checking CloudFormation templates..."

  if ! command -v cfn-lint &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install cfn-lint
    else
      pip3 install cfn-lint
    fi
  fi

  cfn-lint --non-zero-exit-code error || FAILED=1
fi

if [ -f .golangci.yml ]; then
  echo "Checking Go..."

  if ! command -v golangci-lint &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install golangci-lint
    else
      go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
      export PATH="${PATH}:${HOME}/go/bin"
    fi
  fi

  golangci-lint run || FAILED=1
fi

if [ -f .pmd.xml ]; then
  echo "Checking Java/JS/SQL with pmd..."

  if ! command -v pmd &>/dev/null; then
    brew install pmd
  fi

  pmd check --dir . --format textcolor --rulesets ".pmd.xml" || FAILED=1
  echo
fi

# .eslintrc.json is the legacy config format, which requires eslint@8.
# eslint v9+ only supports the flat config format (eslint.config.js/mjs).
if [ -f .eslintrc.json ]; then
  echo "Checking JS with eslint..."

  INSTALL_ESLINT=0

  if ! command -v eslint &>/dev/null; then
    echo "Installing eslint@8 because not present"
    INSTALL_ESLINT=1
  fi

  if ! eslint --version | grep "^v8\." &>/dev/null; then
    echo "Installing eslint@8 because wrong version"
    INSTALL_ESLINT=1
  fi

  if [ ${INSTALL_ESLINT} -eq 1 ]; then
    if uname -s | grep Darwin &>/dev/null; then
      npm install -g eslint@8
    else
      if ! command -v npm &>/dev/null; then
        sudo apt-get --yes install --no-install-recommends npm
      fi

      if command -v npm | grep "${HOME}" &>/dev/null; then
        SUDO=""
      else
        SUDO="sudo"
      fi

      ${SUDO} npm install -g eslint@8
    fi
  fi

  eslint --ignore-pattern "vendor/" --ignore-pattern "node_modules/" --ignore-pattern "Libraries/" --ignore-pattern "Pods/" . || FAILED=1
fi

if [ -f .editorconfig ]; then
  echo "Checking Kotlin with ktlint..."

  if ! command -v ktlint &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install ktlint
    else
      sudo apt-get --yes install --no-install-recommends ktlint
    fi
  fi

  ktlint --verbose || FAILED=1
fi

if [ -f .bandit ]; then
  echo "Checking Python with bandit..."

  if ! command -v bandit &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install bandit
    else
      sudo apt-get --yes install --no-install-recommends python3-bandit
    fi
  fi

  bandit -ll --ini .bandit --silent . || FAILED=1
  echo
fi

if [ -f .flake8 ]; then
  echo "Checking Python with flake8..."

  if ! command -v flake8 &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install flake8
    else
      sudo apt-get --yes install --no-install-recommends flake8
    fi
  fi

  #if ! pip3 list | grep flake8-docstrings &>/dev/null; then
  #  pip3 install --upgrade flake8-docstrings
  #fi

  flake8 --exclude=vendor,node_modules,Libraries,Pods . || FAILED=1
fi

if [ -f .protolint.yaml ]; then
  echo "Checking Protocol Buffer with protolint..."

  if ! command -v protolint &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew tap yoheimuta/protolint
      brew install protolint
    else
      go install github.com/yoheimuta/protolint/cmd/protolint@latest
      export PATH="${PATH}:${HOME}/go/bin"
    fi
  fi

  protolint . || FAILED=1
fi

if [ -f .rubocop.yml ]; then
  echo "Checking Ruby..."

  if ! rubocop --version &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      gem install rubocop rubocop-capybara rubocop-graphql rubocop-i18n rubocop-minitest rubocop-performance rubocop-rails rubocop-rake rubocop-rspec rubocop-rspec_rails rubocop-thread_safety
    else
      if command -v gem | grep "${HOME}" &>/dev/null; then
        SUDO=""
      else
        SUDO="sudo"
      fi

      ${SUDO} gem install rubocop rubocop-capybara rubocop-graphql rubocop-i18n rubocop-minitest rubocop-performance rubocop-rails rubocop-rake rubocop-rspec rubocop-rspec_rails rubocop-thread_safety
    fi
  fi

  rubocop || FAILED=1
  echo
fi

if [ -f .semgrepignore ]; then
  echo "Checking with semgrep..."

  if ! command -v semgrep &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install semgrep
    else
      pip3 install semgrep
    fi
  fi

  semgrep scan --config=auto --severity=ERROR --error --quiet . || FAILED=1
fi

if [ -f .trivyignore ]; then
  echo "Checking with trivy..."

  if ! command -v trivy &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install trivy
    else
      curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
    fi
  fi

  SCANNERS="secret"

  if [ -f .cfnlintrc ] || [ -f .hadolint.yaml ] || \
     find . -maxdepth 3 -name "*.tf" -print -quit 2>/dev/null | grep -q . || \
     find . -maxdepth 3 -name "Dockerfile*" -print -quit 2>/dev/null | grep -q .; then
    SCANNERS="${SCANNERS},misconfig"
  fi

  for lock_file in package-lock.json yarn.lock pnpm-lock.yaml go.sum \
                   requirements.txt Pipfile.lock poetry.lock \
                   Gemfile.lock composer.lock \
                   pom.xml build.gradle build.gradle.kts \
                   Cargo.lock Package.resolved; do
    if [ -f "${lock_file}" ]; then
      SCANNERS="${SCANNERS},vuln"
      break
    fi
  done

  echo "Trivy scanners: ${SCANNERS}"
  trivy fs --scanners "${SCANNERS}" --exit-code 1 . || FAILED=1
fi

if [ -f .swiftlint.yml ]; then
  echo "Checking Swift..."

  if ! command -v swiftlint &>/dev/null; then
    if uname -s | grep Darwin &>/dev/null; then
      brew install swiftlint
    else
      echo "Error: only supported on MacOS!"
      exit 1
    fi
  fi

  swiftlint lint --strict || FAILED=1
fi

if [ ${FAILED} -eq 1 ]; then
  echo "Some checks failed."
  exit 1
fi

echo "All checks passed."
