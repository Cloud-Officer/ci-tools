---
name: Cron Dependencies
'on':
  schedule:
  - cron: "40 * * * *"
env:
  RUBY-BUNDLER-CACHE: 'true'
  RUBY-VERSION: 4.0.0
jobs:
  update_dependencies:
    name: Update Dependencies
    permissions:
      actions: write
      checks: write
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - name: Setup
      id: setup
      uses: cloud-officer/ci-actions/setup@master
      with:
        ruby-version: "${{env.RUBY-VERSION}}"
        ruby-bundler-cache: "${{env.RUBY-BUNDLER-CACHE}}"
        ssh-key: "${{secrets.SSH_KEY}}"
        aws-access-key-id: "${{secrets.AWS_ACCESS_KEY_ID}}"
        aws-secret-access-key: "${{secrets.AWS_SECRET_ACCESS_KEY}}"
        aws-region: "${{secrets.AWS_DEFAULT_REGION}}"
    - name: Update Dependencies
      shell: bash
      run: |
        git config --global --add url."https://${{secrets.SOUP_DEPENDENCIES_UPDATE}}:x-oauth-basic@github.com/".insteadOf ssh://git@github.com:
        git config --global --add url."https://${{secrets.SOUP_DEPENDENCIES_UPDATE}}:x-oauth-basic@github.com/".insteadOf https://github.com/
        git config --global --add url."https://${{secrets.SOUP_DEPENDENCIES_UPDATE}}:x-oauth-basic@github.com/".insteadOf git@github.com:

        bundle config set frozen false ; bundle update
    - name: Licenses
      uses: cloud-officer/ci-actions/soup@master
      with:
        ssh-key: "${{secrets.SSH_KEY}}"
        github-token: "${{secrets.SOUP_DEPENDENCIES_UPDATE}}"
        parameters: "--no_prompt --soup"
        skip-checkout: 'true'
    - name: Create Pull Request
      shell: bash
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        BRANCH="update-dependencies-${{github.run_id}}"
        git checkout -b "$BRANCH"
        git add -A
        git diff --staged --quiet && echo "No changes to commit" && exit 0
        DIFF_STAT=$(git diff --staged --stat)
        git commit -m "Update dependencies" -m "$DIFF_STAT"
        git push origin "$BRANCH"
        gh pr create --fill --base master
      env:
        GH_TOKEN: "${{secrets.SOUP_DEPENDENCIES_UPDATE}}"
    - name: Generate PR Description
      uses: github/copilot-pr-description@v1
      with:
        github-token: "${{secrets.SOUP_DEPENDENCIES_UPDATE}}"
