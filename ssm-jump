#!/usr/bin/env bash
set -euo pipefail

positional=()
profile=""
autoselect_first="false"
filter=""
forward=""
proxycommand_port=""
parameters=""
document="AWS-StartPortForwardingSessionToRemoteHost"

# fatal helper
fatal() {
  echo "$*" >&2
  exit 1
}

while [[ $# -gt 0 ]]; do
  key="${1}"

  case ${key} in
    -h | --help)
      echo "Usage: ssm-jump [options] internal-ip|instance-id|instance-name"
      echo "Options:"
      echo "  -h, --help                                   Print this help message"
      echo "  -p, --profile <profile>                      Specify the aws cli profile to use"
      echo "  -a, --autoselect-first                       Automatically select first matching instance without prompting"
      echo "  -f, --forward <host:remote_port:local_port>  Create a TCP tunnel to a host inside the VPC"
      echo "  -c, --proxy-command <remote_port>            Establish an SSH session to be used as ProxyCommand"
      echo "  -d, --document <ssm-document-name>           AWS Systems Manager document name (default: ${document})"
      exit 0
      ;;
    -a | --autoselect-first)
      autoselect_first="true"
      shift # past argument
      ;;
    -f | --forward)
      forward="${2}"
      shift # past argument
      shift # past value
      ;;
    -c | --proxy-command)
      proxycommand_port="${2}"
      shift # past argument
      shift # past value
      ;;
    -p | --profile)
      profile="${2}"
      shift # past argument
      shift # past value
      ;;
    -d | --document)
      document="${2}"
      shift # past argument
      shift # past value
      ;;
    *)                     # unknown option
      positional+=("${1}") # save it in an array for later
      shift                # past argument
      ;;
  esac
done

set -- "${positional[@]}" # restore positional parameters

# first positional argument is the target
target="${1:-}"

if [ -z "${profile}" ]; then
  fatal "No profile specified !"
fi

if [ -z "${target}" ]; then
  fatal "No target specified !"
fi

if [ ! -z "${forward}" ]; then
  IFS=":" read -a forward_array <<< "${forward}"
  if [ ${#forward_array[@]} -ne 3 ]; then
    fatal "The forward string needs exactly 3 parts, ${#forward_array[@]} given."
  fi
fi

# perform target lookup (AWS SSM target *must* be an EC2 instance ID)
if echo "${target}" | grep -qE '^i-.*'; then
  instances="${target} NONE NONE"
  echo "using instance ID ${target}" >&2
elif echo "${target}" | grep -qE '^([0-9]{1,3}\.){3}[0-9]{1,3}$'; then
  filter="Name=private-ip-address,Values=${target}"
elif echo "${target}" | grep -qE '^[a-z0-9\-]+$'; then
  filter="Name=tag:Name,Values=${target}"
else
  fatal "Invalid target '${target}' !"
fi

if [ -n "${filter}" ]; then
  instances="$(aws --profile "${profile}" ec2 describe-instances --filters "Name=instance-state-name,Values=running" "${filter}" --query "Reservations[*].Instances[*].{a: InstanceId, b: PrivateIpAddress, c: Tags[?Key=='Name'] | [0].Value}" --output text | sort -n)"

  if [ -z "${instances}" ]; then
	fatal "Unable to detect any instance for target ${target}"
  fi
fi

if "${autoselect_first}"; then
  instances=$(echo "${instances}" | head -n1)
fi

if [ "$(echo "${instances}" | wc -l | tr -d ' ')" = "1" ]; then
  instance_id=$(echo "${instances}" | awk '{ print $1 }')
else
  max_lines=0

  while IFS= read -r line; do
    max_lines=$((max_lines + 1))
    printf "%-2d\t%s\n" "${max_lines}" "${line}"
  done <<< "${instances}"

  input=0

  while ! [[ ${input} =~ ^[0-9]+$ ]] || [ ${input} -lt 1 ] || [ ${input} -gt "${max_lines}" ]; do
    echo -n "Connect to what line ? "
    read -r input
  done

  max_lines=0

  while IFS= read -r line; do
    max_lines=$((max_lines + 1))

    if [ "${max_lines}" -eq "${input}" ]; then
      instance_id=$(echo "${line}" | awk '{ print $1 }')
    fi
  done <<< "${instances}"
fi

if [ -n "${proxycommand_port}" ]; then
  if ! echo "${proxycommand_port}" | grep -qE '^[0-9]+$'; then
    fatal "Port must be numeric: ${proxycommand_port}"
  fi

  # for proxycommand, we *must* start an SSH session
  document="AWS-StartSSHSession"

  echo "aws --profile "${profile}" ssm start-session --target "${instance_id}" --document-name "${document}" --parameters "portNumber=${proxycommand_port}""
  exec aws --profile "${profile}" ssm start-session --target "${instance_id}" --document-name "${document}" --parameters "portNumber=${proxycommand_port}"

elif [ -z "${forward}" ]; then
  echo "aws --profile \"${profile}\" ssm start-session --target \"${instance_id}\""
  exec aws --profile "${profile}" ssm start-session --target "${instance_id}"

else
  forward_host=${forward_array[0]}
  forward_remote_port=${forward_array[1]}
  forward_local_port=${forward_array[2]}

  # Validate port numbers are numeric
  if ! echo "${forward_remote_port}" | grep -qE '^[0-9]+$'; then
    fatal "Remote port must be numeric: ${forward_remote_port}"
  fi
  if ! echo "${forward_local_port}" | grep -qE '^[0-9]+$'; then
    fatal "Local port must be numeric: ${forward_local_port}"
  fi

  # Use jq for proper JSON construction to prevent injection
  parameters=$(jq -n \
    --arg host "${forward_host}" \
    --arg port "${forward_remote_port}" \
    --arg localPort "${forward_local_port}" \
    '{host: [$host], portNumber: [$port], localPortNumber: [$localPort]}')

  echo "aws --profile \"${profile}\" ssm start-session --target \"${instance_id}\" --document-name \"${document}\" --parameters '${parameters}'"
  exec aws --profile "${profile}" ssm start-session --target "${instance_id}" --document-name "${document}" --parameters "${parameters}"
fi
